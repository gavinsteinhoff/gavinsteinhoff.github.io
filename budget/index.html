<!doctype html>
<html lang="en">
<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css">
    <title>Hello, world!</title>
</head>
<body style="overflow-x: hidden">



    <div class="row">
        <div class="col-auto">
            <p>Add New File:</p>
            <input id="csv" type="file">
            <ul class="list-group list-group-flush">
                <a href="#" id="clearData" class="list-group-item list-group-item-action">Clear Data</a>
                <li class="list-group-item">Average Balance: <span id="average"></span></li>
                <li class="list-group-item">Highest Amount: <span id="high"></span></li>
                <li class="list-group-item">Lowest Amount: <span id="low"></span></li>
            </ul>
        </div>
        <div class="col">
            <canvas id="myChart"></canvas>
        </div>
    </div>




    <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js"></script>

    <script src="./papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.4.0/Chart.min.js"></script>



    <script>

        var statements = [];
        var myLineChart;


        $(function () {
            if (load() != null)
                statements = load();
            $.each(statements, function (key, statement) {
                graph()
                genNumbers();
            });


        });

        function newStatement(data) {
            var open = data[0][4];
            var close = data[data.length - 1][4]
            var interest = data[data.length - 2][3];
            data.shift();
            data.pop();
            data.pop();
            var tran = [];
            $.each(data, function (key, value) {
                var balance = parseFloat(value[4].split("$")[1]);
                tran.push(new Transaction(value[0], value[2], value[3], balance));
            })
            var statement = (new Statement(open, close, interest, tran));
            if (statements.filter(s=> s.openingBalance === statement.openingBalance && s.closingBalance === statement.closingBalance).length > 0) {
                alert("That statement is already in the system");
                return;
            }
            statements.push(statement);
            save();
            graph();
            genNumbers();
        }

        var fileInput = document.getElementById("csv");
        readFile = function () {
            var reader = new FileReader();
            reader.readAsText(fileInput.files[0]);
            reader.onload = function () {
                var data = (Papa.parse(reader.result, {
                    skipEmptyLines: true
                }).data);
                newStatement(data);
                fileInput.value = '';
            };
        };
        fileInput.addEventListener('change', readFile);


        function save() {
            var jsonString = JSON.stringify(statements);
            localStorage.setItem("data", jsonString);
        }

        function load() {
            var data = JSON.parse(localStorage.getItem('data'));
            return data;
        }

        function genNumbers() {
            var avg = 0;
            var balances = [];
            $.each(statements, function (key, statement) {
                $.each(statement.transactions, function (key, value) {
                    avg += value.newBalance;
                    balances.push(value.newBalance);
                });
            });
            avg = avg / balances.length;
            $("#average").html("$" + avg.toFixed(2));
            $("#high").html("$" + fixZero(Math.max(...balances)));
            $("#low").html("$" + fixZero(Math.min(...balances)));
        }

        function fixZero(value) {
            if (value.toString().split(".")[1].length != 2) return value + "0"; else return value;
        }

        function graph() {
            var lables = new Array();
            var data = new Array();
            $.each(statements, function (key, statement) {
                $.each(statement.transactions, function (key, value) {
                    lables.push(value.date);
                    data.push(value.newBalance).toString();
                });
            });
            var canvas = document.getElementById('myChart');
            var data = {
                labels: lables,
                datasets: [
                    {
                        label: "Balance",
                        fill: false,
                        lineTension: .1,
                        backgroundColor: "rgba(75,192,192,0.4)",
                        borderColor: "rgba(75,192,192,1)",
                        pointBorderColor: "rgba(75,192,192,1)",
                        pointBackgroundColor: "#fff",
                        pointBorderWidth: 1,
                        pointHoverRadius: 5,
                        pointHoverBackgroundColor: "rgba(75,192,192,1)",
                        pointHoverBorderColor: "rgba(220,220,220,1)",
                        pointHoverBorderWidth: 2,
                        pointRadius: 5,
                        pointHitRadius: 1,
                        data: data,
                    }
                ]
            };
            var option = {
                showLines: true,
                tooltips: {
                    callbacks: {
                        label: function (tooltipItem, data) {
                            var tran;
                            $.each(statements, function (key, statement) {
                                $.each(statement.transactions, function (key, transaction) {
                                    if (transaction.date == tooltipItem.xLabel && transaction.newBalance == tooltipItem.yLabel) {
                                        tran = transaction;
                                        return false;
                                    }
                                });
                                if (tran != null) return false;
                            });
                            var output = tran.amount + " " + tran.desc;
                            return output;
                        },
                        title: function (tooltipItem, data) {
                            var tran;
                            var tooltipItem = tooltipItem[0];
                            $.each(statements, function (key, statement) {
                                $.each(statement.transactions, function (key, transaction) {
                                    if (transaction.date == tooltipItem.xLabel && transaction.newBalance == tooltipItem.yLabel) {
                                        tran = transaction;
                                        return false;
                                    }
                                });
                                if (tran != null) return false;
                            });
                            var output = tooltipItem.xLabel + " $" + tran.newBalance;
                            return output;
                        }
                    }
                }
            };
            if (myLineChart != null) myLineChart.clear();
            myLineChart = Chart.Line(canvas, {
                data: data,
                options: option
            });


        }


        $("#clearData").click(function () {
            localStorage.clear();
            statements = [];
            myLineChart.clear();
            $("#average").html("");
            $("#high").html("");
            $("#low").html("");
        });



        class Statement {
            constructor(open, close, interest, tran) {
                this.openingBalance = open;
                this.closingBalance = close;
                this.interest = interest;
                this.transactions = tran;
            }
        }

        class Transaction {
            constructor(date, desc, amount, newBalance) {
                this.date = date;
                this.desc = desc;
                this.amount = amount;
                this.newBalance = newBalance;
            }
        }
    </script>



</body>
</html>